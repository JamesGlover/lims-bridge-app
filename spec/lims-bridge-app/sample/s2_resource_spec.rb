require 'lims-bridge-app/sample/spec_helper'
require 'lims-bridge-app/sample/json_decoder'
require 'lims-bridge-app/s2_resource'

module Lims::BridgeApp::SampleManagement
  describe "S2 resource mapping" do
    let(:convertor) do
      Class.new do
        include Lims::BridgeApp::SampleManagement::JsonDecoder
        include Lims::BridgeApp::S2Resource
      end.new
    end
    let(:result) { convertor.s2_resource(payload) }

    shared_examples_for "a sample" do
      it "returns a hash" do
        result.should be_a(Hash)
      end

      it "returns a sample resource" do
        result[:sample].should be_a(Lims::ManagementApp::Sample)
      end

      it "returns the sample uuid" do
        result[:uuid].should_not be_nil
        result[:uuid].should be_a(String)
      end

      it "returns the date" do
        result[:date].should_not be_nil
        result[:date].should be_a(String)
      end
    end

    shared_examples_for "a group of samples" do
      it "returns a hash" do
        result.should be_a(Hash)
      end

      it "contains the right number of samples" do
        result[:samples].size.should == 3
      end

      it "returns sample resources" do
        result[:samples].each do |element|
          element[:sample].should be_a(Lims::ManagementApp::Sample)
          element[:uuid].should_not be_nil
          element[:date].should_not be_nil
        end
      end
    end

    context "sample message" do
      let(:payload) { '{"sample":{"actions":{"read":"http://localhost:9292/92419010-a4fd-0130-4de7-282066132de2","create":"http://localhost:9292/92419010-a4fd-0130-4de7-282066132de2","update":"http://localhost:9292/92419010-a4fd-0130-4de7-282066132de2","delete":"http://localhost:9292/92419010-a4fd-0130-4de7-282066132de2"},"uuid":"92419010-a4fd-0130-4de7-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-a78412a01473451fbf556df6ab12d258","sample_type":"RNA","taxon_id":9606,"scientific_name":"homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}},"action":"create","date":"2013-05-22 11:06:27 UTC","user":"user"}' }
      it_behaves_like "a sample"
    end

    context "bulk create sample message" do
      let(:payload) { <<-EOD
      {"bulk_create_sample":{"actions":{},"user":"user","application":"application","result":{"samples":[{"actions":{"read":"http://localhost:9292/80dd3f40-a4ff-0130-4de7-282066132de2","create":"http://localhost:9292/80dd3f40-a4ff-0130-4de7-282066132de2","update":"http://localhost:9292/80dd3f40-a4ff-0130-4de7-282066132de2","delete":"http://localhost:9292/80dd3f40-a4ff-0130-4de7-282066132de2"},"uuid":"80dd3f40-a4ff-0130-4de7-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-4aac72437c7d477b91eeebe05b564655","sample_type":"RNA","taxon_id":9606,"scientific_name":"homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}},{"actions":{"read":"http://localhost:9292/80dd8950-a4ff-0130-4de7-282066132de2","create":"http://localhost:9292/80dd8950-a4ff-0130-4de7-282066132de2","update":"http://localhost:9292/80dd8950-a4ff-0130-4de7-282066132de2","delete":"http://localhost:9292/80dd8950-a4ff-0130-4de7-282066132de2"},"uuid":"80dd8950-a4ff-0130-4de7-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-59e3ac9188a54662b412a8d1e4224d79","sample_type":"RNA","taxon_id":9606,"scientific_name":"homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}},{"actions":{"read":"http://localhost:9292/80ddd600-a4ff-0130-4de7-282066132de2","create":"http://localhost:9292/80ddd600-a4ff-0130-4de7-282066132de2","update":"http://localhost:9292/80ddd600-a4ff-0130-4de7-282066132de2","delete":"http://localhost:9292/80ddd600-a4ff-0130-4de7-282066132de2"},"uuid":"80ddd600-a4ff-0130-4de7-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-60201576fed84b70bb2d332de5fd86a2","sample_type":"RNA","taxon_id":9606,"scientific_name":"homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}}]},"volume":100,"date_of_sample_collection":"2013-06-24","is_sample_a_control":true,"is_re_submitted_sample":false,"hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"rna":null,"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"},"common_name":"man","quantity":3,"gender":"Male","sample_type":"RNA","taxon_id":9606,"supplier_sample_name":"supplier sample name","scientific_name":"homo sapiens"},"action":"bulk_create_sample","date":"2013-05-22 11:20:16 UTC","user":"user"}
      EOD
      } 
      it_behaves_like "a group of samples"
    end

    context "bulk update sample message" do
      let(:payload) { <<-EOD
      {"bulk_update_sample":{"actions":{},"user":"user","application":"application","result":{"samples":[{"actions":{"read":"http://localhost:9292/35a71640-a6a1-0130-4e5f-282066132de2","create":"http://localhost:9292/35a71640-a6a1-0130-4e5f-282066132de2","update":"http://localhost:9292/35a71640-a6a1-0130-4e5f-282066132de2","delete":"http://localhost:9292/35a71640-a6a1-0130-4e5f-282066132de2"},"uuid":"35a71640-a6a1-0130-4e5f-282066132de2","supplier_sample_name":"new supplier sample name","gender":"Hermaphrodite","sanger_sample_id":"S2-0c48361bd5804ee588db87a6c0159cee","sample_type":"Blood","taxon_id":9604,"scientific_name":"Hominidae","common_name":"great apes","hmdmc_number":"new 123456","ebi_accession_number":"new accession number","sample_source":"new sample source","mother":"new mother","father":"new father","sibling":"new sibling","gc_content":"new gc content","public_name":"new public name","cohort":"new cohort","storage_conditions":"new storage conditions","volume":101,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":false,"is_re_submitted_sample":true,"dna":{"pre_amplified":true,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"new extraction method","concentration":121,"sample_purified":true,"concentration_determined_by_which_method":"new method"},"cellular_material":{"lysed":true},"genotyping":{"country_of_origin":"new england","geographical_region":"new europe","ethnicity":"new english"}},{"actions":{"read":"http://localhost:9292/35a75f20-a6a1-0130-4e5f-282066132de2","create":"http://localhost:9292/35a75f20-a6a1-0130-4e5f-282066132de2","update":"http://localhost:9292/35a75f20-a6a1-0130-4e5f-282066132de2","delete":"http://localhost:9292/35a75f20-a6a1-0130-4e5f-282066132de2"},"uuid":"35a75f20-a6a1-0130-4e5f-282066132de2","supplier_sample_name":"new supplier sample name","gender":"Hermaphrodite","sanger_sample_id":"S2-846184b0a5ce4d58a77df6c02651975c","sample_type":"Blood","taxon_id":9604,"scientific_name":"Hominidae","common_name":"great apes","hmdmc_number":"new 123456","ebi_accession_number":"new accession number","sample_source":"new sample source","mother":"new mother","father":"new father","sibling":"new sibling","gc_content":"new gc content","public_name":"new public name","cohort":"new cohort","storage_conditions":"new storage conditions","volume":101,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":false,"is_re_submitted_sample":true,"dna":{"pre_amplified":true,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"new extraction method","concentration":121,"sample_purified":true,"concentration_determined_by_which_method":"new method"},"cellular_material":{"lysed":true},"genotyping":{"country_of_origin":"new england","geographical_region":"new europe","ethnicity":"new english"}},{"actions":{"read":"http://localhost:9292/35a7a2b0-a6a1-0130-4e5f-282066132de2","create":"http://localhost:9292/35a7a2b0-a6a1-0130-4e5f-282066132de2","update":"http://localhost:9292/35a7a2b0-a6a1-0130-4e5f-282066132de2","delete":"http://localhost:9292/35a7a2b0-a6a1-0130-4e5f-282066132de2"},"uuid":"35a7a2b0-a6a1-0130-4e5f-282066132de2","supplier_sample_name":"new supplier sample name","gender":"Hermaphrodite","sanger_sample_id":"S2-31f2c0d6e11947bc85571c2bdd179ba5","sample_type":"Blood","taxon_id":9604,"scientific_name":"Hominidae","common_name":"great apes","hmdmc_number":"new 123456","ebi_accession_number":"new accession number","sample_source":"new sample source","mother":"new mother","father":"new father","sibling":"new sibling","gc_content":"new gc content","public_name":"new public name","cohort":"new cohort","storage_conditions":"new storage conditions","volume":101,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":false,"is_re_submitted_sample":true,"dna":{"pre_amplified":true,"date_of_sample_extraction":"2013-06-02T00:00:00+00:00","extraction_method":"new extraction method","concentration":121,"sample_purified":true,"concentration_determined_by_which_method":"new method"},"cellular_material":{"lysed":true},"genotyping":{"country_of_origin":"new england","geographical_region":"new europe","ethnicity":"new english"}}]},"volume":101,"date_of_sample_collection":"new 2013-06-24","is_sample_a_control":false,"is_re_submitted_sample":true,"hmdmc_number":"new 123456","ebi_accession_number":"new accession number","sample_source":"new sample source","mother":"new mother","father":"new father","sibling":"new sibling","gc_content":"new gc content","public_name":"new public name","cohort":"new cohort","storage_conditions":"new storage conditions","dna":{"pre_amplified":true,"date_of_sample_extraction":"new 2013-06-02","extraction_method":"new extraction method","concentration":121,"sample_purified":true,"concentration_determined_by_which_method":"new method"},"rna":null,"cellular_material":{"lysed":true},"genotyping":{"country_of_origin":"new england","geographical_region":"new europe","ethnicity":"new english"},"common_name":"great apes","sample_uuids":["35a71640-a6a1-0130-4e5f-282066132de2","35a75f20-a6a1-0130-4e5f-282066132de2","35a7a2b0-a6a1-0130-4e5f-282066132de2"],"sanger_sample_ids":null,"gender":"Hermaphrodite","sample_type":"Blood","taxon_id":9604,"supplier_sample_name":"new supplier sample name","scientific_name":"Hominidae"},"action":"bulk_update_sample","date":"2013-05-24 13:10:20 UTC","user":"user"}
      EOD
      }
      it_behaves_like "a group of samples"
    end

    context "bulk delete sample message" do
      let(:payload) { <<-EOD
      {"bulk_delete_sample":{"actions":{},"user":"user","application":"application","result":{"samples":[{"actions":{"read":"http://localhost:9292/45477440-a6a1-0130-4e5f-282066132de2","create":"http://localhost:9292/45477440-a6a1-0130-4e5f-282066132de2","update":"http://localhost:9292/45477440-a6a1-0130-4e5f-282066132de2","delete":"http://localhost:9292/45477440-a6a1-0130-4e5f-282066132de2"},"uuid":"45477440-a6a1-0130-4e5f-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-cd9b200ec5634288ad5b4f56eab2a84f","sample_type":"RNA","taxon_id":9606,"scientific_name":"Homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+01:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}},{"actions":{"read":"http://localhost:9292/4547c560-a6a1-0130-4e5f-282066132de2","create":"http://localhost:9292/4547c560-a6a1-0130-4e5f-282066132de2","update":"http://localhost:9292/4547c560-a6a1-0130-4e5f-282066132de2","delete":"http://localhost:9292/4547c560-a6a1-0130-4e5f-282066132de2"},"uuid":"4547c560-a6a1-0130-4e5f-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-745819ae3dfe401caa68a87a90c95a4c","sample_type":"RNA","taxon_id":9606,"scientific_name":"Homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+01:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}},{"actions":{"read":"http://localhost:9292/45481b30-a6a1-0130-4e5f-282066132de2","create":"http://localhost:9292/45481b30-a6a1-0130-4e5f-282066132de2","update":"http://localhost:9292/45481b30-a6a1-0130-4e5f-282066132de2","delete":"http://localhost:9292/45481b30-a6a1-0130-4e5f-282066132de2"},"uuid":"45481b30-a6a1-0130-4e5f-282066132de2","supplier_sample_name":"supplier sample name","gender":"Male","sanger_sample_id":"S2-97322cddad764d5f98b5255e3d329c66","sample_type":"RNA","taxon_id":9606,"scientific_name":"Homo sapiens","common_name":"man","hmdmc_number":"123456","ebi_accession_number":"accession number","sample_source":"sample source","mother":"mother","father":"father","sibling":"sibling","gc_content":"gc content","public_name":"public name","cohort":"cohort","storage_conditions":"storage conditions","volume":100,"date_of_sample_collection":"2013-06-24T00:00:00+01:00","is_sample_a_control":true,"is_re_submitted_sample":false,"dna":{"pre_amplified":false,"date_of_sample_extraction":"2013-06-02T00:00:00+01:00","extraction_method":"extraction method","concentration":120,"sample_purified":false,"concentration_determined_by_which_method":"method"},"cellular_material":{"lysed":false},"genotyping":{"country_of_origin":"england","geographical_region":"europe","ethnicity":"english"}}]},"sample_uuids":["45477440-a6a1-0130-4e5f-282066132de2","4547c560-a6a1-0130-4e5f-282066132de2","45481b30-a6a1-0130-4e5f-282066132de2"],"sanger_sample_ids":null},"action":"bulk_delete_sample","date":"2013-05-24 13:10:46 UTC","user":"user"}
      EOD
      }
      it_behaves_like "a group of samples"
    end
  end
end
